image: docker:stable
services:
    - docker:18.09-dind
variables:
    TAG_IMAGE: "V2.0.1"
    IMAGE_NAME: "myimg"
    RESOURCE_GROUP: "myResourceGroup"
    ACI_NAME: "mytcontainerio"
    DOMAIN_NAME: "myt-io"
    PORT: "80"

stages: 
    - build_app
    - build_container
    - tagging
    - package
    - deploy

‚öôbuilding: 
    image: node
    only: 
        - master
    stage: build_app 
    script: 
        - npm install
        - npm run build --prod
    artifacts:
        paths:
            - dist/
 
üö¢dockerise:
    dependencies:
        - ‚öôbuilding
    only: 
        - master
    stage: build_container
    script: 
        - docker info
        - echo "docker yes"
        - docker build -t "$IMAGE_NAME" .
        - mkdir imageDocker/
        - docker save "$IMAGE_NAME" > imageDocker/app.tar
    artifacts:
        paths:
            - imageDocker

üì©tag_image:
    when: manual
    dependencies:
        - üö¢dockerise
    stage: tagging
    only:
        - master
    script:
        - docker load -i imageDocker/app.tar
        - docker tag "$IMAGE_NAME" "$ACR_URL"/"$IMAGE_NAME":"$TAG_IMAGE"
        - mkdir finalImage
        - docker save "$ACR_URL"/"$IMAGE_NAME" > finalImage/appFinal.tar
    artifacts:
        paths:
            - finalImage


        
‚òÅ push_acr: 
    stage: package
    only:
        - master
    script:      
        - docker login -u "$ACR_TOKEN_NAME" -p "$ACR_TOKEN" "$ACR_URL"
        - docker load -i finalImage/appFinal.tar
        - docker push "$ACR_URL"/"$IMAGE_NAME":"$TAG_IMAGE"

üåßverify_azure:
    stage: deploy
    only:
        - master
    image: microsoft/azure-cli
    script: |
        az login --service-principal --username "$AAD_ID" --password "$AAD_SECRET" --tenant "$TENANT_ID"

        az container create --resource-group myResourceGroup --name mytcontainer --image "$ACR_URL"/"$IMAGE_NAME":"$TAG_IMAGE" --cpu 1 --memory 1 --registry-login-server "$ACR_URL" --registry-username "$AAD_ID" --registry-password "$AAD_SECRET" --dns-name-label "$DOMAIN_NAME" --ports "$PORT"




# Ameliorer la recuperation de l'artifact