image: docker:stable
services:
    - docker:18.09-dind
variables:
    TAG_IMAGE: "V2"
    IMAGE_NAME: "myimg"

stages: 
    - verify 
    - build_app
    - build_container
    - login
    - tag_image
    - package
    - deploy
    - realease

âš™building: 
    image: node
    only: 
        - master
    stage: build_app 
    script: 
        - npm install
        - npm run build --prod
    artifacts:
        paths:
            - dist/
 
ğŸš¢dockerise:
    dependencies:
        - âš™building
    only: 
        - master
    stage: build_app
    script: 
        - docker info
        - echo "docker yes"
        - docker build -t "$IMAGE_NAME" .
        - mkdir imageDocker/
        - docker save "$IMAGE_NAME" > imageDocker/app.tar
    artifacts:
        paths:
            - imageDocker

ğŸ“©tag_image:
    dependencies:
        - ğŸš¢dockerise
    stage: package
    only:
        - master
    script:
        - docker load -i imageDocker/app.tar
        - docker tag "$IMAGE_NAME" "$ACR_URL"/"$IMAGE_NAME":"$TAG_IMAGE"
        - mkdir finalImage
        - docker save "$ACR_URL"/"$IMAGE_NAME" > finalImage/appFinal.tar
    artifacts:
        paths:
            - finalImage

ğŸ”‘login_acr: 
    dependencies: 
        - ğŸ“©tag_image
    stage: package
    only:
        - master
    script:
        - docker login -u "$ACR_TOKEN_NAME" -p "$ACR_TOKEN" "$ACR_URL"

â˜ push_acr: 
    stage: package
    only:
        - master
    script:      
        - docker load -i finalImage/appFinal.tar
        - docker push "$ACR_URL"/"$IMAGE_NAME":"$TAG_IMAGE"

ğŸŒ§verify_azure:
    stage: deploy
    only:
        - master
    image: microsoft/azure-cli
    script:
        - az acr repository list --name "$ACR_NAME" --output table





# Ameliorer la recuperation de l'artifact